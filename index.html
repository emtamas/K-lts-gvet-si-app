<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vállalkozási Költségvetés</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .container { max-width: 1200px; }
        .card { background-color: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: 600; transition: background-color 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal { position: fixed; inset: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
    </style>
</head>
<body class="bg-gray-100 p-8 flex items-center justify-center min-h-screen">
    <div id="loading-screen" class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500 mx-auto"></div>
        <p class="mt-4 text-gray-600">Betöltés...</p>
    </div>

    <!-- Auth UI -->
    <div id="auth-container" class="w-full max-w-sm hidden">
        <div class="card p-8 space-y-4">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-800">Bejelentkezés</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email cím</label>
                    <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required />
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Jelszó</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required />
                </div>
                <button type="submit" id="auth-submit-btn" class="w-full btn bg-indigo-600 text-white hover:bg-indigo-700">Bejelentkezés</button>
            </form>
            <div class="text-center text-sm">
                <button id="toggle-auth" class="text-indigo-600 hover:underline">Még nincs fiókom, regisztrálok</button>
            </div>
            <p id="auth-message" class="text-red-500 text-sm text-center hidden"></p>
        </div>
    </div>

    <!-- App UI -->
    <div id="app-container" class="container mx-auto space-y-8 hidden">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800">Vállalkozási Költségvetés</h1>
        </header>
        <!-- Mód-szalag -->
        <div id="mode-banner" class="hidden mb-4">
            <div class="card p-4 flex items-center justify-between bg-yellow-50">
                <div class="text-sm text-gray-700">
                    <strong>Demó (előnézet) mód</strong> – jelenleg minta adatok látszanak.
                </div>
                <div class="flex items-center gap-2">
                    <button id="switch-to-live" class="btn bg-indigo-600 text-white hover:bg-indigo-700 text-sm">Átváltás élő módra</button>
                </div>
            </div>
        </div>

        <!-- User Info -->
        <div class="card p-4 text-center">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div>
                    <span class="text-sm font-semibold text-gray-500">Felhasználó:</span>
                    <span id="user-email" class="text-sm font-bold text-gray-700">Betöltés...</span>
                </div>
                <button id="logout-btn" class="mt-2 md:mt-0 btn bg-red-500 text-white hover:bg-red-600 text-sm py-1 px-3">Kijelentkezés</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="card p-6 grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div class="flex flex-col items-center">
                <span class="text-sm font-semibold text-gray-500">Összes Bevétel</span>
                <span id="total-income" class="text-3xl font-extrabold text-green-600 mt-1">0 Ft</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-sm font-semibold text-gray-500">Összes Kiadás</span>
                <span id="total-expense" class="text-3xl font-extrabold text-red-600 mt-1">0 Ft</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-sm font-semibold text-gray-500">Egyenleg</span>
                <span id="balance" class="text-3xl font-extrabold text-blue-600 mt-1">0 Ft</span>
            </div>
        </div>
        <div class="card p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 text-center">
            <div class="flex flex-col items-center">
                <span class="text-sm font-semibold text-gray-500">Számlás Tranzakciók (nettó)</span>
                <span id="total-invoiced" class="text-2xl font-bold text-gray-800 mt-1">0 Ft</span>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-sm font-semibold text-gray-500">Nem számlás Tranzakciók (nettó)</span>
                <span id="total-not-invoiced" class="text-2xl font-bold text-gray-800 mt-1">0 Ft</span>
            </div>
        </div>

        <!-- Havi kimutatás -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Havi kimutatás</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hónap</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bevétel</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kiadás</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Egyenleg</th>
                        </tr>
                    </thead>
                    <tbody id="monthly-table" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- New Transaction -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Új Tranzakció Hozzáadása</h2>
            <form id="transaction-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Dátum</label>
                        <input type="date" id="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required />
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Leírás</label>
                        <input type="text" id="description" placeholder="Pl. Takarmány beszerzés" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required />
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">Összeg (Ft)</label>
                        <input type="number" id="amount" placeholder="10000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required />
                    </div>
                    <div>
                        <label for="business-area" class="block text-sm font-medium text-gray-700">Üzletág</label>
                        <select id="business-area" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                            <option value="Állatpanzió">Állatpanzió</option>
                            <option value="Kutyakiképzés">Kutyakiképzés</option>
                            <option value="Webshop">Webshop</option>
                            <option value="Állatasszisztált terápia">Állatasszisztált terápia</option>
                            <option value="Állattartás">Állattartás (Nyúl/Tyúk/Fürj)</option>
                            <option value="Tojás értékesítés">Tojás értékesítés</option>
                            <option value="Egyéb mérnöki">Egyéb mérnöki</option>
                        </select>
                    </div>
                    <div>
                        <label for="payment-method" class="block text-sm font-medium text-gray-700">Fizetési mód</label>
                        <select id="payment-method" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                            <option value="Készpénz">Készpénz</option>
                            <option value="Utalás">Utalás</option>
                            <option value="MyPOS">MyPOS</option>
                            <option value="Barion">Barion</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4 mt-6">
                        <label class="inline-flex items-center">
                            <input type="radio" name="transaction-type" value="income" checked class="h-4 w-4" />
                            <span class="ml-2 text-sm text-gray-700">Bevétel</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="transaction-type" value="expense" class="h-4 w-4" />
                            <span class="ml-2 text-sm text-gray-700">Kiadás</span>
                        </label>
                    </div>
                    <div class="flex items-center space-x-2 mt-6">
                        <input type="checkbox" id="invoiced" class="h-4 w-4" />
                        <label for="invoiced" class="text-sm text-gray-700">Számla</label>
                    </div>
                </div>
                <button type="submit" class="w-full btn bg-indigo-600 text-white hover:bg-indigo-700">Tranzakció hozzáadása</button>
            </form>
        </div>

        <!-- Transactions Table -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Részletes Tranzakciók</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dátum</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Üzletág</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Leírás</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Összeg</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fizetési Mód</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Számla</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Típus</th>
                            <th class="px-6 py-3"></th>
                        </tr>
                    </thead>
                    <tbody id="transaction-list" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="mt-4 text-center">
                <button id="clear-all" class="text-sm text-red-500 hover:text-red-700">Összes adat törlése</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Megerősítés</h3>
            <p id="confirm-message" class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">Mégse</button>
                <button id="confirm-ok" class="btn bg-red-500 text-white hover:bg-red-600">Törlés</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            doc,
            deleteDoc,
            getDocs,
            writeBatch,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Domain / mód felismerés + manuális felülbírálás ---
        const url = new URL(location.href);
        const forcePreview = url.searchParams.get('preview') === '1';
        const forceLive = url.searchParams.get('live') === '1' || localStorage.getItem('forceLive') === '1';

        const ALLOWED = [
            'localhost',
            '127.0.0.1',
            'vallalkozasi-koltsegvetes-app.web.app',
            'vallalkozasi-koltsegvetes-app.firebaseapp.com'
            // Itt egészítsd ki a saját GitHub Pages / custom domain hostnévvel!
            // pl.: 'marton-tamas.github.io', 'montyallatpanzio.hu'
        ];
        const isAllowed = ALLOWED.includes(location.hostname)
            || location.hostname.endsWith('.github.io')
            || location.hostname.endsWith('web.app')
            || location.hostname.endsWith('firebaseapp.com');

        const PREVIEW = forcePreview ? true : (forceLive ? false : !isAllowed);

        // Firebase konfiguráció
        const firebaseConfig = {
            apiKey: "AIzaSyDNIjjqn3U954Liv_Uevb_98kBI7yz9_Mk",
            authDomain: "vallalkozasi-koltsegvetes-app.firebaseapp.com",
            projectId: "vallalkozasi-koltsegvetes-app",
            storageBucket: "vallalkozasi-koltsegvetes-app.appspot.com",
            messagingSenderId: "957517210915",
            appId: "1:957517210915:web:9811f265ee72d4e1381896"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // UI elemek
        const loadingScreen = document.getElementById('loading-screen');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const toggleAuthBtn = document.getElementById('toggle-auth');
        const authMessage = document.getElementById('auth-message');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdSpan = document.getElementById('user-email');
        const switchToLiveBtn = document.getElementById('switch-to-live');
        const modeBanner = document.getElementById('mode-banner');

        const transactionForm = document.getElementById('transaction-form');
        const transactionList = document.getElementById('transaction-list');
        const totalIncomeSpan = document.getElementById('total-income');
        const totalExpenseSpan = document.getElementById('total-expense');
        const balanceSpan = document.getElementById('balance');
        const totalInvoicedSpan = document.getElementById('total-invoiced');
        const totalNotInvoicedSpan = document.getElementById('total-not-invoiced');
        const clearAllBtn = document.getElementById('clear-all');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmCancelBtn = document.getElementById('confirm-cancel');
        const confirmOkBtn = document.getElementById('confirm-ok');

        let isLoginMode = true;
        let unsubscribeFromTransactions = null;
        let currentUserId = null;

        const showMessage = (message, isError = true) => {
            authMessage.textContent = message;
            authMessage.style.color = isError ? 'red' : 'green';
            authMessage.classList.remove('hidden');
        };

        function toYM(dateStr){
            const d = dateStr ? new Date(dateStr) : null;
            if (!d || isNaN(d)) return 'Ismeretlen';
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        }

        function renderMonthlyTable(monthly){
            const monthlyTable = document.getElementById('monthly-table');
            if (!monthlyTable) return;
            monthlyTable.innerHTML = '';
            const months = Array.from(monthly.keys()).sort().reverse();
            months.forEach((ym) => {
                const { income, expense } = monthly.get(ym);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-3 text-sm text-gray-700">${ym}</td>
                    <td class="px-6 py-3 text-sm text-green-700">${income.toLocaleString('hu-HU')} Ft</td>
                    <td class="px-6 py-3 text-sm text-red-700">${expense.toLocaleString('hu-HU')} Ft</td>
                    <td class="px-6 py-3 text-sm font-semibold">${(income - expense).toLocaleString('hu-HU')} Ft</td>`;
                monthlyTable.appendChild(tr);
            });
        }

        // --- Preview mód: Firebase nélkül demó adatokkal ---
        function runPreviewDemo() {
            modeBanner.classList.remove('hidden');
            switchToLiveBtn.addEventListener('click', () => {
                localStorage.setItem('forceLive', '1');
                location.href = location.pathname + '?live=1';
            });

            loadingScreen.classList.add('hidden');
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            userIdSpan.textContent = 'preview@local.test';

            const demo = [
                { date: '2025-08-12', businessArea: 'Webshop', description: 'Rendelés #A123', amount: 42000, paymentMethod: 'Barion', invoiced: true, type: 'income' },
                { date: '2025-08-13', businessArea: 'Állatpanzió', description: 'Takarmány', amount: 15000, paymentMethod: 'Utalás', invoiced: false, type: 'expense' },
                { date: '2025-09-01', businessArea: 'Kutyakiképzés', description: 'Csoportos óra díj', amount: 18000, paymentMethod: 'Készpénz', invoiced: true, type: 'income' },
                { date: '2025-09-02', businessArea: 'Állattartás', description: 'Állatorvosi költség', amount: 12000, paymentMethod: 'Utalás', invoiced: true, type: 'expense' }
            ];

            let totalIncome = 0, totalExpense = 0;
            let totalInvoicedNet = 0, totalNotInvoicedNet = 0;
            const monthly = new Map();
            transactionList.innerHTML = '';

            demo.forEach((d) => {
                const amount = Number(d.amount) || 0;
                const isIncome = d.type === 'income';
                if (isIncome) totalIncome += amount; else totalExpense += amount;
                if (d.invoiced) totalInvoicedNet += isIncome ? amount : -amount; else totalNotInvoicedNet += isIncome ? amount : -amount;

                const ym = toYM(d.date);
                if (!monthly.has(ym)) monthly.set(ym, { income: 0, expense: 0 });
                const b = monthly.get(ym);
                if (isIncome) b.income += amount; else b.expense += amount;

                const row = document.createElement('tr');
                row.className = isIncome ? 'bg-green-50' : 'bg-red-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.businessArea}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${isIncome ? 'text-green-600' : 'text-red-600'}">${amount.toLocaleString('hu-HU')} Ft</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.paymentMethod}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.invoiced ? '✅' : '❌'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${isIncome ? 'Bevétel' : 'Kiadás'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="opacity-40 cursor-not-allowed" disabled>Törlés</button>
                    </td>`;
                transactionList.appendChild(row);
            });

            totalIncomeSpan.textContent = `${totalIncome.toLocaleString('hu-HU')} Ft`;
            totalExpenseSpan.textContent = `${totalExpense.toLocaleString('hu-HU')} Ft`;
            balanceSpan.textContent = `${(totalIncome - totalExpense).toLocaleString('hu-HU')} Ft`;
            totalInvoicedSpan.textContent = `${totalInvoicedNet.toLocaleString('hu-HU')} Ft`;
            totalNotInvoicedSpan.textContent = `${totalNotInvoicedNet.toLocaleString('hu-HU')} Ft`;
            renderMonthlyTable(monthly);
        }

        const showApp = (user) => {
            loadingScreen.classList.add('hidden');
            authContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            userIdSpan.textContent = user.email;
            currentUserId = user.uid;

            if (unsubscribeFromTransactions) unsubscribeFromTransactions();

            const qRef = query(collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`));
            unsubscribeFromTransactions = onSnapshot(qRef, (querySnapshot) => {
                let totalIncome = 0;
                let totalExpense = 0;
                let totalInvoicedNet = 0;
                let totalNotInvoicedNet = 0;
                const monthly = new Map();
                transactionList.innerHTML = '';

                if (querySnapshot.empty) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan=\"8\" class=\"px-6 py-4 text-center text-sm text-gray-500\">Nincsenek tranzakciók.</td>`;
                    transactionList.appendChild(row);
                } else {
                    querySnapshot.forEach((txDoc) => {
                        const data = txDoc.data();
                        const amount = Number(data.amount) || 0;
                        const isIncome = data.type === 'income';

                        if (isIncome) totalIncome += amount; else totalExpense += amount;
                        if (data.invoiced) totalInvoicedNet += isIncome ? amount : -amount; else totalNotInvoicedNet += isIncome ? amount : -amount;

                        const ym = toYM(data.date);
                        if (!monthly.has(ym)) monthly.set(ym, { income: 0, expense: 0 });
                        const bucket = monthly.get(ym);
                        if (isIncome) bucket.income += amount; else bucket.expense += amount;

                        const row = document.createElement('tr');
                        row.className = isIncome ? 'bg-green-50' : 'bg-red-50';
                        row.innerHTML = `
                            <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${data.date ?? ''}</td>
                            <td class=\"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900\">${data.businessArea ?? ''}</td>
                            <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${data.description ?? ''}</td>
                            <td class=\"px-6 py-4 whitespace-nowrap text-sm ${isIncome ? 'text-green-600' : 'text-red-600'}\">${amount.toLocaleString('hu-HU')} Ft</td>
                            <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${data.paymentMethod ?? ''}</td>
                            <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${data.invoiced ? '✅' : '❌'}</td>
                            <td class=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">${isIncome ? 'Bevétel' : 'Kiadás'}</td>
                            <td class=\"px-6 py-4 whitespace-nowrap text-right text-sm font-medium\">
                                <button data-id=\"${txDoc.id}\" class=\"text-indigo-600 hover:text-indigo-900 delete-btn\">Törlés</button>
                            </td>`;
                        transactionList.appendChild(row);
                    });
                }

                totalIncomeSpan.textContent = `${totalIncome.toLocaleString('hu-HU')} Ft`;
                totalExpenseSpan.textContent = `${totalExpense.toLocaleString('hu-HU')} Ft`;
                balanceSpan.textContent = `${(totalIncome - totalExpense).toLocaleString('hu-HU')} Ft`;
                totalInvoicedSpan.textContent = `${totalInvoicedNet.toLocaleString('hu-HU')} Ft`;
                totalNotInvoicedSpan.textContent = `${totalNotInvoicedNet.toLocaleString('hu-HU')} Ft`;
                renderMonthlyTable(monthly);

                document.querySelectorAll('.delete-btn').forEach((button) => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.currentTarget.dataset.id;
                        confirmMessage.textContent = 'Biztosan törölni szeretnéd ezt a tranzakciót?';
                        confirmOkBtn.textContent = 'Törlés';
                        confirmModal.classList.remove('hidden');
                        confirmOkBtn.onclick = async () => {
                            try {
                                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/transactions/${docId}`);
                                await deleteDoc(docRef);
                                confirmModal.classList.add('hidden');
                            } catch (error) {
                                console.error('Hiba a tranzakció törlésekor:', error);
                                confirmModal.classList.add('hidden');
                            }
                        };
                        confirmCancelBtn.onclick = () => confirmModal.classList.add('hidden');
                    });
                });
            }, (error) => {
                console.error('Hiba a tranzakciók figyelésekor:', error);
            });
        };

        const showAuth = () => {
            loadingScreen.classList.add('hidden');
            appContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
        };

        // Auth state
        if (PREVIEW) {
            runPreviewDemo();
        } else {
            onAuthStateChanged(auth, (user) => {
                if (user) showApp(user); else showAuth();
            });
        }

        // Auth submit
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            authSubmitBtn.disabled = true;
            authMessage.classList.add('hidden');

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage('Sikeres regisztráció! Jelentkezz be.', false);
                    isLoginMode = true;
                    authTitle.textContent = 'Bejelentkezés';
                    authSubmitBtn.textContent = 'Bejelentkezés';
                    toggleAuthBtn.textContent = 'Még nincs fiókom, regisztrálok';
                }
            } catch (error) {
                console.error('Auth hiba:', error);
                let message = 'Hiba történt. Kérlek, próbáld újra.';
                if (error.code === 'auth/invalid-email') message = 'Hibás email cím.';
                else if (error.code === 'auth/user-not-found') message = 'A felhasználó nem található.';
                else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') message = 'Hibás jelszó.';
                else if (error.code === 'auth/email-already-in-use') message = 'Az email cím már használatban van.';
                else if (error.code === 'auth/weak-password') message = 'A jelszónak legalább 6 karakter hosszúnak kell lennie.';
                showMessage(message);
            } finally {
                authSubmitBtn.disabled = false;
            }
        });

        // Toggle login/register
        toggleAuthBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                authTitle.textContent = 'Bejelentkezés';
                authSubmitBtn.textContent = 'Bejelentkezés';
                toggleAuthBtn.textContent = 'Még nincs fiókom, regisztrálok';
            } else {
                authTitle.textContent = 'Regisztráció';
                authSubmitBtn.textContent = 'Regisztráció';
                toggleAuthBtn.textContent = 'Már van fiókom, bejelentkezem';
            }
            authMessage.classList.add('hidden');
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try { await signOut(auth); } catch (error) { console.error('Kijelentkezési hiba:', error); }
        });

        // Add transaction
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) { showMessage('Nincs bejelentkezett felhasználó. Kérlek, jelentkezz be.'); return; }

            const newTransaction = {
                date: (document.getElementById('date').value || '').trim(),
                description: (document.getElementById('description').value || '').trim(),
                amount: Number(document.getElementById('amount').value) || 0,
                businessArea: document.getElementById('business-area').value,
                paymentMethod: document.getElementById('payment-method').value,
                type: document.querySelector('input[name="transaction-type"]:checked').value,
                invoiced: document.getElementById('invoiced').checked,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`), newTransaction);
                transactionForm.reset();
                document.getElementById('date').valueAsDate = new Date();
            } catch (error) {
                console.error('Hiba a tranzakció hozzáadásakor:', error);
                showMessage('Hiba a tranzakció hozzáadásakor. Kérlek, ellenőrizd a beállításokat.');
            }
        });

        // Clear all transactions
        clearAllBtn.addEventListener('click', async () => {
            confirmMessage.textContent = 'Biztosan törölni szeretnéd az összes tranzakciót? Ez a művelet nem vonható vissza!';
            confirmOkBtn.textContent = 'Törlés';
            confirmModal.classList.remove('hidden');

            confirmOkBtn.onclick = async () => {
                try {
                    const qRef = query(collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`));
                    const snap = await getDocs(qRef);
                    const batch = writeBatch(db);
                    snap.forEach((d) => batch.delete(d.ref));
                    await batch.commit();
                    confirmModal.classList.add('hidden');
                } catch (error) {
                    console.error('Hiba az összes adat törlésekor:', error);
                    confirmModal.classList.add('hidden');
                }
            };
            confirmCancelBtn.onclick = () => confirmModal.classList.add('hidden');
        });

        // Kezdő dátum
        document.getElementById('date').valueAsDate = new Date();
    </script>
</body>
</html>
